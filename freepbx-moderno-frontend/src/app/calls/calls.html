<!-- src/app/calls/calls.html -->
<div class="p-6 space-y-6">
  <!-- Header -->
  <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
    <div class="flex items-center gap-4">
      <div class="w-12 h-12 rounded-[50px] bg-[#2E86AB] flex items-center justify-center shadow-lg">
        <span class="material-icons text-white text-2xl">call</span>
      </div>
      <div>
        <h1 class="text-3xl font-bold text-gray-800">Llamadas Detalladas</h1>
        <p class="text-sm text-gray-500 mt-1">Historial completo de llamadas del sistema</p>
      </div>
    </div>
  </div>
<!-- Reemplazar la sección de filtros en src/app/calls/calls.html -->

<!-- Filtros Avanzados y Refresh -->
<div class="bg-white rounded-2xl border border-gray-200 p-5 shadow-lg">
  <!-- Primera fila: Filtros de Periodo -->
  <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4 mb-4">
    <div class="flex flex-wrap gap-2">
      <button 
        (click)="changePeriod('today')" 
        [class.filter-active]="currentPeriod === 'today'"
        class="filter-btn">
        <span class="material-icons-outlined text-base mr-1.5">today</span>
        Hoy
      </button>
      <button 
        (click)="changePeriod('week')" 
        [class.filter-active]="currentPeriod === 'week'"
        class="filter-btn">
        <span class="material-icons-outlined text-base mr-1.5">date_range</span>
        Últimos 7 días
      </button>
      <button 
        (click)="changePeriod('month')" 
        [class.filter-active]="currentPeriod === 'month'"
        class="filter-btn">
        <span class="material-icons-outlined text-base mr-1.5">calendar_month</span>
        Últimos 30 días
      </button>
      <button 
        (click)="changePeriod('year')" 
        [class.filter-active]="currentPeriod === 'year'"
        class="filter-btn">
        <span class="material-icons-outlined text-base mr-1.5">event</span>
        Último año
      </button>
    </div>
    
    <button 
      (click)="loadCalls(currentPage)" 
      [disabled]="loading" 
      class="btn-refresh">
      <span class="material-icons-outlined text-lg" [class.rotate-animation]="loading">refresh</span>
      {{ loading ? 'Cargando...' : 'Recargar datos' }}
    </button>
  </div>

  <!-- Segunda fila: Búsqueda y Filtros Adicionales -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
    <!-- Búsqueda -->
    <div class="search-box-calls">
      <span class="material-icons-outlined search-icon-calls">search</span>
      <input 
        type="text" 
        [(ngModel)]="searchTerm"
        (input)="onSearchChange()"
        placeholder="Buscar por número o agente..."
        class="search-input-calls"/>
      @if (searchTerm) {
        <button 
          (click)="clearSearch()"
          class="clear-search-btn">
          <span class="material-icons-outlined text-sm">close</span>
        </button>
      }
    </div>

    <!-- Filtro por Estado -->
    <div class="filter-select-wrapper">
      <span class="material-icons-outlined filter-icon">filter_list</span>
      <select 
        [(ngModel)]="filterStatus"
        (change)="applyFilters()"
        class="filter-select">
        <option value="">Todos los estados</option>
        <option value="ANSWERED">Contestadas</option>
        <option value="NO ANSWER">No contestadas</option>
        <option value="BUSY">Ocupadas</option>
        <option value="FAILED">Fallidas</option>
      </select>
    </div>

    <!-- Filtro por Cola -->
    <div class="filter-select-wrapper">
      <span class="material-icons-outlined filter-icon">queue</span>
      <select 
        [(ngModel)]="filterQueue"
        (change)="applyFilters()"
        class="filter-select">
        <option value="">Todas las colas</option>
        <option value="Sí">Con cola</option>
        <option value="No">Sin cola</option>
      </select>
    </div>

    <!-- Botón de Exportar -->
    <button 
      (click)="exportToCSV()"
      [disabled]="calls.length === 0"
      class="export-btn">
      <span class="material-icons-outlined text-base mr-1.5">download</span>
      Exportar CSV
    </button>
  </div>

  <!-- Stats rápidos -->
  @if (!loading && calls.length > 0) {
    <div class="mt-4 pt-4 border-t border-gray-100">
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <div class="quick-stat">
          <span class="material-icons-outlined text-green-600 text-lg">call</span>
          <div>
            <p class="text-xs text-gray-500">Total</p>
            <p class="text-lg font-bold text-gray-800">{{ totalCalls }}</p>
          </div>
        </div>
        <div class="quick-stat">
          <span class="material-icons-outlined text-blue-600 text-lg">check_circle</span>
          <div>
            <p class="text-xs text-gray-500">Contestadas</p>
            <p class="text-lg font-bold text-blue-600">{{ getAnsweredCount() }}</p>
          </div>
        </div>
        <div class="quick-stat">
          <span class="material-icons-outlined text-amber-600 text-lg">schedule</span>
          <div>
            <p class="text-xs text-gray-500">Espera Prom.</p>
            <p class="text-lg font-bold text-amber-600">{{ getAverageWaitTime() }}s</p>
          </div>
        </div>
        <div class="quick-stat">
          <span class="material-icons-outlined text-purple-600 text-lg">timer</span>
          <div>
            <p class="text-xs text-gray-500">Duración Prom.</p>
            <p class="text-lg font-bold text-purple-600">{{ getAverageDuration() }}s</p>
          </div>
        </div>
      </div>
    </div>
  }

  <!-- Resumen -->
  <div class="mt-4 pt-4 border-t border-gray-100">
    <div class="flex items-center gap-2 text-sm">
      <span class="material-icons-outlined text-[#2E86AB] text-base">info</span>
      <span class="text-gray-600">
        Mostrando <span class="font-semibold text-gray-800">{{ filteredCalls.length }}</span> de 
        <span class="font-semibold text-gray-800">{{ totalCalls }}</span> llamadas
      </span>
      @if (totalPages > 1) {
        <span class="text-gray-400">•</span>
        <span class="text-gray-600">
          Página <span class="font-semibold text-gray-800">{{ currentPage }}</span> de 
          <span class="font-semibold text-gray-800">{{ totalPages }}</span>
        </span>
      }
      @if (searchTerm || filterStatus || filterQueue) {
        <span class="text-gray-400">•</span>
        <span class="text-[#2E86AB] font-medium">Filtros activos</span>
      }
    </div>
  </div>
</div>

  @if (loading) {
    <div class="table-skeleton">
      <!-- Header de tabla skeleton -->
      <div class="grid grid-cols-9 gap-4 px-6 py-3 bg-gray-50 border-b border-gray-200">
        <div class="col-span-1"><div class="skeleton-line short"></div></div>
        <div class="col-span-1"><div class="skeleton-line short"></div></div>
        <div class="col-span-1"><div class="skeleton-line short"></div></div>
        <div class="col-span-1"><div class="skeleton-line short"></div></div>
        <div class="col-span-1"><div class="skeleton-line short"></div></div>
        <div class="col-span-1"><div class="skeleton-line short"></div></div>
        <div class="col-span-1"><div class="skeleton-line short"></div></div>
        <div class="col-span-1"><div class="skeleton-line short"></div></div>
        <div class="col-span-1"><div class="skeleton-line short"></div></div>
      </div>

      <!-- Rows skeleton -->
      @for (i of [1,2,3,4,5,6,7,8]; track i) {
        <div class="grid grid-cols-9 gap-4 px-6 py-4 border-b border-gray-100">
          <div class="skeleton-cell"><div class="skeleton-line"></div></div>
          <div class="skeleton-cell"><div class="skeleton-line"></div></div>
          <div class="skeleton-cell"><div class="skeleton-line short"></div></div>
          <div class="skeleton-cell"><div class="skeleton-line medium"></div></div>
          <div class="skeleton-cell"><div class="skeleton-line"></div></div>
          <div class="skeleton-cell"><div class="skeleton-line short"></div></div>
          <div class="skeleton-cell"><div class="skeleton-line short"></div></div>
          <div class="skeleton-cell"><div class="skeleton-line short"></div></div>
          <div class="skeleton-cell"><div class="skeleton-line medium"></div></div>
        </div>
      }
    </div>
  }

  <!-- Sin Resultados -->
@else if (filteredCalls.length === 0 && !loading) {
  <div class="bg-white rounded-2xl border border-gray-200 p-12 text-center shadow-lg">
    <div class="w-20 h-20 rounded-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center mx-auto mb-4">
      <span class="material-icons-outlined text-gray-400 text-4xl">call_end</span>
    </div>
    @if (searchTerm || filterStatus || filterQueue) {
      <h3 class="text-xl font-semibold text-gray-800 mb-2">No se encontraron resultados</h3>
      <p class="text-gray-500">Intenta modificar los filtros de búsqueda</p>
      <button 
        (click)="clearSearch(); filterStatus=''; filterQueue=''; applyFilters()"
        class="mt-4 btn-primary">
        Limpiar filtros
      </button>
    } @else {
      <h3 class="text-xl font-semibold text-gray-800 mb-2">No hay llamadas en este período</h3>
      <p class="text-gray-500">Intenta seleccionar un rango de fechas diferente</p>
    }
  </div>
}

  <!-- Tabla de Llamadas -->
@else if (filteredCalls.length > 0) {
    <div class="calls-table-modern">
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-100 border-b border-gray-200">
            <tr>
              <th>
                <div class="flex items-center gap-2">
                  <span class="material-icons-outlined text-base">schedule</span>
                  Fecha y Hora
                </div>
              </th>
              <th>
                <div class="flex items-center gap-2">
                  <span class="material-icons-outlined text-base">phone</span>
                  Número
                </div>
              </th>
              <th>
                <div class="flex items-center gap-2">
                  <span class="material-icons-outlined text-base">queue</span>
                  Cola
                </div>
              </th>
              <th>
                <div class="flex items-center gap-2">
                  <span class="material-icons-outlined text-base">dialpad</span>
                  Número Agente
                </div>
              </th>
              <th>
                <div class="flex items-center gap-2">
                  <span class="material-icons-outlined text-base">person</span>
                  Agente
                </div>
              </th>
              <th>
                <div class="flex items-center gap-2">
                  <span class="material-icons-outlined text-base">check_circle</span>
                  Estado
                </div>
              </th>
              <th>
                <div class="flex items-center gap-2">
                  <span class="material-icons-outlined text-base">hourglass_empty</span>
                  Espera
                </div>
              </th>
              <th>
                <div class="flex items-center gap-2">
                  <span class="material-icons-outlined text-base">timer</span>
                  Duración
                </div>
              </th>
              <th>
                <div class="flex items-center gap-2">
                  <span class="material-icons-outlined text-base">more_horiz</span>
                  Acciones
                </div>
              </th>
            </tr>
          </thead>
          <tbody>
            @for (call of filteredCalls; track call.uniqueid) {
              <tr class="call-row">
                <!-- Fecha y Hora -->
                <td>
                  <div class="flex flex-col">
                    <span class="text-sm font-medium text-gray-800">{{ call.fecha | date:'dd/MM/yyyy' }}</span>
                    <span class="text-xs text-gray-500 mt-0.5">{{ call.fecha | date:'HH:mm:ss' }}</span>
                  </div>
                </td>

                <!-- Número -->
                <td>
                  <div class="flex items-center gap-2">
                    <span class="font-medium text-gray-800">{{ call.numero }}</span>
                  </div>
                </td>

                <!-- Cola -->
                <td>
                  @if (call.cola === 'Sí') {
                    <span class="tag-queue">
                      Sí
                    </span>
                  } @else {
                    <span class="tag-no-queue">
                      No
                    </span>
                  }
                </td>

                <!-- Número Agente -->
                <td>
                  <span class="text-sm font-mono text-gray-700 bg-gray-100 px-2.5 py-1 rounded-lg">
                    {{ call.numero_agente }}
                  </span>
                </td>

                <!-- Agente -->
                <td>
                  <div class="flex items-center gap-2">
                    <div class="w-7 h-7 rounded-full bg-gradient-to-br from-[#28A745] to-[#34d399] flex items-center justify-center text-white text-xs font-bold">
                      {{ call.agente.charAt(0).toUpperCase() }}
                    </div>
                    <span class="text-sm text-gray-800">{{ call.agente }}</span>
                  </div>
                </td>

                <!-- Estado -->
                <td>
                  @if (call.evento === 'ANSWERED') {
                    <span class="badge-answered">
                      <span class="material-icons-outlined text-xs mr-1">call_received</span>
                      Contestada
                    </span>
                  } @else {
                    <span class="badge-missed">
                      <span class="material-icons-outlined text-xs mr-1">call_missed</span>
                      No contestada
                    </span>
                  }
                </td>

                <!-- Tiempo de Espera -->
                <td>
                  <div class="flex items-center gap-1.5">
                    <div class="w-1.5 h-1.5 rounded-full"
                         [class.bg-green-500]="call.tiempo_espera < 30"
                         [class.bg-amber-500]="call.tiempo_espera >= 30 && call.tiempo_espera < 60"
                         [class.bg-red-500]="call.tiempo_espera >= 60"></div>
                    <span class="text-sm font-medium"
                          [class.text-green-700]="call.tiempo_espera < 30"
                          [class.text-amber-700]="call.tiempo_espera >= 30 && call.tiempo_espera < 60"
                          [class.text-red-700]="call.tiempo_espera >= 60">
                      {{ call.tiempo_espera }}s
                    </span>
                  </div>
                </td>

                <!-- Duración -->
                <td>
                  <span class="text-sm font-semibold text-gray-700">{{ call.tiempo_llamada }}s</span>
                </td>

                <!-- Acciones -->
                <td>
                  <button (click)="viewDetails(call)" class="btn-detail">
                    <span class="material-icons-outlined text-base">visibility</span>
                    Ver más
                  </button>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>

    <!-- Paginación -->
    @if (totalPages > 1) {
      <div class="pagination-modern">
        <div class="flex items-center justify-between">
          <!-- Info de página -->
          <div class="text-sm text-gray-600">
            Mostrando <span class="font-semibold">{{ (currentPage - 1) * pageSize + 1 }}</span> a
            <span class="font-semibold">{{ currentPage * pageSize > totalCalls ? totalCalls : currentPage * pageSize }}</span> de
            <span class="font-semibold">{{ totalCalls }}</span> resultados
          </div>

          <!-- Botones de navegación -->
          <div class="flex items-center gap-2">
            <button
              (click)="goToPage(1)"
              [disabled]="currentPage === 1"
              class="pagination-btn"
              title="Primera página">
              <span class="material-icons-outlined text-lg">first_page</span>
            </button>

            <button
              (click)="goToPage(currentPage - 1)"
              [disabled]="currentPage === 1"
              class="pagination-btn"
              title="Página anterior">
              <span class="material-icons-outlined text-lg">chevron_left</span>
            </button>

            <!-- Números de página -->
            <div class="flex items-center gap-1 mx-2">
              @for (page of [currentPage - 1, currentPage, currentPage + 1]; track page) {
                @if (page > 0 && page <= totalPages) {
                  <button
                    (click)="goToPage(page)"
                    [class.pagination-active]="page === currentPage"
                    class="pagination-number">
                    {{ page }}
                  </button>
                }
              }
            </div>

            <button
              (click)="goToPage(currentPage + 1)"
              [disabled]="currentPage === totalPages"
              class="pagination-btn"
              title="Página siguiente">
              <span class="material-icons-outlined text-lg">chevron_right</span>
            </button>

            <button
              (click)="goToPage(totalPages)"
              [disabled]="currentPage === totalPages"
              class="pagination-btn"
              title="Última página">
              <span class="material-icons-outlined text-lg">last_page</span>
            </button>
          </div>
        </div>
      </div>
    }
  }
</div>